<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lead Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Minimal styling via PicoCSS CDN (tiny, no build step) -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">

  <!-- Leaflet (only used if lat/lon columns exist) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { padding-block: 1rem; }
    .file-drop {
      border: 2px dashed var(--muted-border-color);
      border-radius: .5rem;
      padding: 1rem;
      text-align: center;
      color: var(--muted-color);
      cursor: pointer;
    }
    .file-drop.dragover { background: #f6f8fa; }
    table { white-space: nowrap; }
    th.sortable { cursor: pointer; }
    th.sortable::after { content: " ↕"; opacity: .6; font-size: .9em; }
    .nowrap { white-space: nowrap; }
    #map { height: 260px; border-radius: .5rem; }
    .pill { display:inline-block; border:1px solid #ddd; border-radius:999px; padding:.1rem .5rem; margin-right:.3rem; font-size:.8rem;}
    .muted { color: var(--muted-color); }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1>Lead Viewer</h1>
      <p class="muted">Upload a CSV exported by your scraper to browse, search, and filter leads.</p>
    </header>

    <section id="uploader">
      <div class="grid">
        <div>
          <label for="file">Choose CSV</label>
          <input type="file" id="file" accept=".csv" />
          <small class="muted">Expected headers (flexible): name, categories, rating, review_count, phone, address, city, state, postal_code, website, email, source, latitude, longitude, url, instagram, facebook, tiktok, youtube.</small>
        </div>
        <div class="file-drop" id="drop">
          <strong>Drag & drop</strong> your CSV here<br/>
          <small class="muted">Or click to select</small>
        </div>
      </div>
    </section>

    <section id="controls" style="display:none;">
      <div class="grid">
        <div>
          <label for="search">Search</label>
          <input type="search" id="search" placeholder="Search name / address / email / phone..." />
        </div>
        <div>
          <label for="categoryFilter">Filter by category</label>
          <select id="categoryFilter">
            <option value="">All categories</option>
          </select>
        </div>
        <div>
          <label for="sourceFilter">Source</label>
          <select id="sourceFilter">
            <option value="">All</option>
          </select>
        </div>
        <div>
          <label for="pageSize">Rows per page</label>
          <select id="pageSize">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>250</option>
          </select>
        </div>
      </div>
      <div id="stats" class="muted"></div>
    </section>

    <section id="tableWrap" style="display:none;">
      <table id="table">
        <thead></thead>
        <tbody></tbody>
      </table>
      <nav id="pager" aria-label="Pagination" style="display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-top:.75rem;">
        <button id="prev" class="secondary">‹ Prev</button>
        <span id="pageInfo" class="muted"></span>
        <button id="next" class="secondary">Next ›</button>
      </nav>
    </section>

    <section id="detailWrap" style="display:none; margin-top:1rem;">
      <h3>Lead details</h3>
      <article id="detailCard"></article>
      <div id="mapWrap" style="margin-top:.75rem; display:none;">
        <div id="map"></div>
      </div>
    </section>
  </main>

<script>
(() => {
  let rows = [];
  let filtered = [];
  let sortKey = null;
  let sortDir = 1; // 1 asc, -1 desc
  let page = 1;
  let pageSize = 50;
  let hasLatLon = false;
  let map = null, marker = null;

  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const controls = document.getElementById('controls');
  const tableWrap = document.getElementById('tableWrap');
  const table = document.getElementById('table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  const pager = document.getElementById('pager');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const pageInfo = document.getElementById('pageInfo');
  const searchInput = document.getElementById('search');
  const categoryFilter = document.getElementById('categoryFilter');
  const sourceFilter = document.getElementById('sourceFilter');
  const pageSizeSel = document.getElementById('pageSize');
  const stats = document.getElementById('stats');

  function normalizeKey(k) { return (k || '').toString().trim(); }
  function pick(obj, k) { return normalizeKey(obj[k] ?? obj[k?.toLowerCase?.()] ?? ""); }
  function parseNumber(x) { const n = Number(x); return Number.isFinite(n) ? n : null; }
  function uniq(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

  function parseCSV(file) {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim(),
      complete: (res) => {
        rows = res.data.map(r => ({
          name: pick(r,'name'),
          categories: pick(r,'categories'),
          rating: pick(r,'rating'),
          review_count: pick(r,'review_count'),
          phone: pick(r,'phone'),
          address: pick(r,'address'),
          city: pick(r,'city'),
          state: pick(r,'state'),
          postal_code: pick(r,'postal_code'),
          website: pick(r,'website'),
          email: pick(r,'email'),
          source: pick(r,'source'),
          latitude: pick(r,'latitude'),
          longitude: pick(r,'longitude'),
          url: pick(r,'url'),
          instagram: pick(r,'instagram'),
          facebook: pick(r,'facebook'),
          tiktok: pick(r,'tiktok'),
          youtube: pick(r,'youtube'),
        }));
        hasLatLon = rows.some(r => r.latitude && r.longitude);
        setupFilters();
        applyFilters();
        controls.style.display = '';
        tableWrap.style.display = '';
      }
    });
  }

  function setupFilters(){
    // Category filter options
    const cats = uniq(rows.flatMap(r => (r.categories||'').split(',').map(s=>s.trim()).filter(Boolean)));
    categoryFilter.innerHTML = '<option value="">All categories</option>' + cats.map(c=>`<option>${c}</option>`).join('');
    // Sources
    const sources = uniq(rows.map(r => r.source));
    sourceFilter.innerHTML = '<option value="">All</option>' + sources.map(s=>`<option>${s}</option>`).join('');
  }

  function applyFilters(){
    const q = searchInput.value.toLowerCase().trim();
    const cat = categoryFilter.value;
    const src = sourceFilter.value;
    filtered = rows.filter(r => {
      if (cat && !(r.categories||'').split(',').map(s=>s.trim()).includes(cat)) return false;
      if (src && r.source !== src) return false;
      if (!q) return true;
      const blob = [
        r.name, r.categories, r.address, r.city, r.state, r.postal_code,
        r.phone, r.email, r.website, r.instagram, r.facebook, r.tiktok, r.youtube
      ].join(' ').toLowerCase();
      return blob.includes(q);
    });
    sortAndRender( true );
  }

  function sortAndRender(resetPage=false){
    if (sortKey){
      filtered.sort((a,b)=>{
        const va = (a[sortKey] ?? '').toString().toLowerCase();
        const vb = (b[sortKey] ?? '').toString().toLowerCase();
        if (va < vb) return -1*sortDir;
        if (va > vb) return 1*sortDir;
        return 0;
      });
    }
    if (resetPage) page = 1;
    renderTable();
  }

  function renderTable(){
    pageSize = Number(pageSizeSel.value) || 50;
    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    page = Math.min(Math.max(1, page), pages);
    const start = (page-1)*pageSize;
    const subset = filtered.slice(start, start + pageSize);

    // Header
    const cols = ["name","categories","rating","review_count","phone","email","address","city","state","postal_code","website","source"];
    thead.innerHTML = `
      <tr>
        ${cols.map(c => `<th class="sortable" data-key="${c}">${c.replace('_',' ')}</th>`).join('')}
        <th>links</th>
      </tr>`;

    // Body
    tbody.innerHTML = subset.map((r,i) => {
      const rowIdx = start + i;
      const web = r.website ? `<a href="${r.website}" target="_blank" rel="noopener">site</a>` : '';
      const mapLink = (r.latitude && r.longitude)
        ? `<a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank" rel="noopener">map</a>`
        : (r.url ? `<a href="${r.url}" target="_blank" rel="noopener">map</a>` : '');
      const socials = ["instagram","facebook","tiktok","youtube"]
        .filter(k => r[k]).map(k => `<a href="${r[k]}" target="_blank" rel="noopener">${k}</a>`).join(' ');
      return `
        <tr data-idx="${rowIdx}" class="lead-row">
          <td>${escapeHTML(r.name)}</td>
          <td>${escapeHTML(r.categories)}</td>
          <td class="nowrap">${escapeHTML(r.rating)}</td>
          <td class="nowrap">${escapeHTML(r.review_count)}</td>
          <td class="nowrap">${escapeHTML(r.phone)}</td>
          <td class="nowrap">${escapeHTML(r.email)}</td>
          <td>${escapeHTML(r.address)}</td>
          <td>${escapeHTML(r.city)}</td>
          <td>${escapeHTML(r.state)}</td>
          <td>${escapeHTML(r.postal_code)}</td>
          <td>${r.website ? `<a href="${r.website}" target="_blank" rel="noopener">visit</a>` : ''}</td>
          <td class="nowrap"><span class="pill">${escapeHTML(r.source)}</span></td>
          <td class="nowrap">${[web, mapLink, socials].filter(Boolean).join(' ')}</td>
        </tr>`;
    }).join('');

    // Stats/pager
    stats.textContent = `${total.toLocaleString()} matching leads`;
    pageInfo.textContent = `Page ${page} / ${pages}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= pages;

    // Sorting hooks
    thead.querySelectorAll('th.sortable').forEach(th => {
      th.onclick = () => {
        const key = th.dataset.key;
        if (sortKey === key) sortDir *= -1; else { sortKey = key; sortDir = 1; }
        sortAndRender(false);
      };
    });

    // Row click → details
    tbody.querySelectorAll('tr.lead-row').forEach(tr => {
      tr.onclick = () => {
        const idx = Number(tr.dataset.idx);
        showDetail(filtered[idx]);
      };
    });
  }

  function showDetail(r){
    const wrap = document.getElementById('detailWrap');
    const card = document.getElementById('detailCard');
    const mapWrap = document.getElementById('mapWrap');
    card.innerHTML = `
      <article>
        <header><h4 style="margin:.25rem 0;">${escapeHTML(r.name || '(No name)')}</h4></header>
        <p class="muted" style="margin:.25rem 0;">${escapeHTML(r.categories)}</p>
        <p style="margin:.25rem 0;">
          ${r.address ? escapeHTML(r.address) + '<br/>' : ''}
          ${[r.city, r.state, r.postal_code].filter(Boolean).map(escapeHTML).join(', ')}
        </p>
        <p class="nowrap" style="margin:.25rem 0;">☎ ${escapeHTML(r.phone || '')}</p>
        <p class="nowrap" style="margin:.25rem 0;">✉ ${escapeHTML(r.email || '')}</p>
        <p class="nowrap" style="margin:.25rem 0;">
          ${r.website ? `<a href="${r.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${r.url ? ` · <a href="${r.url}" target="_blank" rel="noopener">Map</a>` : ''}
        </p>
        <p>${["instagram","facebook","tiktok","youtube"].filter(k=>r[k]).map(k=>`<a href="${r[k]}" target="_blank" rel="noopener">${k}</a>`).join(' · ')}</p>
        <footer class="muted">Source: ${escapeHTML(r.source || '')}${r.rating ? ` · Rating: ${escapeHTML(r.rating)}` : ''}${r.review_count ? ` · Reviews: ${escapeHTML(r.review_count)}` : ''}</footer>
      </article>
    `;
    wrap.style.display = '';

    // Map if coords present
    if (r.latitude && r.longitude){
      const lat = parseFloat(r.latitude), lon = parseFloat(r.longitude);
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        mapWrap.style.display = '';
        if (!map){
          map = L.map('map');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
          }).addTo(map);
        }
        if (marker){ marker.remove(); }
        map.setView([lat, lon], 14);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(r.name || 'Lead').openPopup();
      } else {
        mapWrap.style.display = 'none';
      }
    } else {
      mapWrap.style.display = 'none';
    }
  }

  function escapeHTML(s){
    return (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // Events
  searchInput?.addEventListener('input', () => applyFilters());
  categoryFilter?.addEventListener('change', () => applyFilters());
  sourceFilter?.addEventListener('change', () => applyFilters());
  pageSizeSel?.addEventListener('change', () => sortAndRender(true));
  prevBtn.onclick = () => { page--; renderTable(); };
  nextBtn.onclick = () => { page++; renderTable(); };

  fileInput.addEventListener('change', e => {
    if (e.target.files?.[0]) parseCSV(e.target.files[0]);
  });

  // Drag & drop
  drop.addEventListener('click', () => fileInput.click());
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
  drop.addEventListener('drop', e => {
    e.preventDefault(); drop.classList.remove('dragover');
    if (e.dataTransfer.files?.[0]) parseCSV(e.dataTransfer.files[0]);
  });
})();
</script>
</body>
</html>
